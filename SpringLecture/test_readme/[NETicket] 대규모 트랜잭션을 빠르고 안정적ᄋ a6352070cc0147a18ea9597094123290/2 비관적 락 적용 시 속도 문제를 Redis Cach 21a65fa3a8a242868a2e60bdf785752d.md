# 2. ë¹„ê´€ì  ë½ ì ìš© ì‹œ ì†ë„ ë¬¸ì œë¥¼ Redis Cacheë¡œ í•´ê²°

## ğŸ†˜ ë¬¸ì œ

<aside>
âš ï¸ ë¬¸ì œ : ë¹„ê´€ì  ë½ì„ ì ìš©í•˜ê³  ì˜ˆë§¤ ë¡œì§ì— 10K ìš”ì²­ í…ŒìŠ¤íŠ¸ ì§„í–‰ ì‹œ í‰ê·  ì‘ë‹µì†ë„ 49368ms( 77tps) ìˆ˜ì¤€ìœ¼ë¡œ ì§€ë‚˜ì¹˜ê²Œ ëŠë ¤ ì†ë„ ê°œì„ ì´ í•„ìš”í–ˆìŠµë‹ˆë‹¤.

</aside>

| ë¼ë²¨ | í‘œë³¸ ìˆ˜ | í‰ê·  ì‘ë‹µ ì†ë„ | ìµœì†Œê°’ | ìµœëŒ€ê°’ | í‘œì¤€í¸ì°¨ | ì˜¤ë¥˜ % | ì²˜ë¦¬ëŸ‰(tps) | ìˆ˜ì‹  KB/ì´ˆ | ì „ì†¡ KB/ì´ˆ | í‰ê·  ë°”ì´íŠ¸ ìˆ˜ |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| ë¹„ê´€ì ë½ ì ìš© | 10000 | 49368ms | 167 | 113230 | 30585.155171191138 | 0.1466 | 77.66145817153863 | 52.308033313367865 | 26.989465101853 | 689.7041 |

---

## ğŸ‘â€ğŸ—¨ ë¶„ì„

```java
@Transactional
  public Long makeReservations(ReservationRequestDto dto, User user) {
    TicketInfo ticketInfo = ticketInfoRepository.**findByIdWithLock**(dto.getTicketInfoId()).orElseThrow(
        () -> new IllegalArgumentException("ê³µì—°íšŒì°¨ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.")
    );

// ------------------------------------------------------------
public interface TicketInfoRepository extends JpaRepository<TicketInfo, Long> {

  @Lock(LockModeType.PESSIMISTIC_WRITE)
  @Query("SELECT t FROM TicketInfo t WHERE t.id = :id")
  Optional<TicketInfo> findByIdWithLock(@Param("id") Long id);
}
```

<aside>
ğŸ’¡ ë¹„ê´€ì  ì“°ê¸° ë½ì´ ë°ì´í„° ë¬´ê²°ì„±ì„ ì§€í‚¤ê¸°ëŠ” ì¢‹ì§€ë§Œ DBì—ì„œ íŠ¸ëœì­ì…˜ì´ ëë‚  ë•Œê¹Œì§€ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì˜ ì ‘ê·¼ì„ ë§‰ê¸° ë•Œë¬¸ì— ì†ë„ê°€ ì €í•˜ëœë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤.

</aside>

---

## ğŸŒŸì‹œë„

### 1. Redisë¥¼ ë„ì…í•´ ë¹„ê´€ì  ë½ì„ ëŒ€ì‹ í•´ Redisson ë½ì„ ì ìš©

- ì˜ˆë§¤ ë¡œì§ êµ¬í˜„ ì½”ë“œ
    
    ```java
    @Configuration
    public class RedisConfig {
    
      @Value("${spring.redis.host}")
      private String host;
    
      @Value("${spring.redis.port}")
      private int port;
    
      @Bean
      public RedisConnectionFactory redisConnectionFactory() {
        return new RedissonConnectionFactory();
      }
    
      @Bean(destroyMethod = "shutdown")
      public RedissonClient redissonClient() {
        Config config = new Config();
        config.useSingleServer()
            .setAddress("redis://" + host + ":" + port);
        return Redisson.create(config);
      }
    }
    
    // -----------------------------------------------
    @Service
    @RequiredArgsConstructor
    public class ReservationLockFacade {
    
      private final ReservationService reservationService;
      private final RedissonClient redissonClient;
    
      public Long makeReservation(ReservationRequestDto dto, User user){
        Long ticketInfoId = dto.getTicketInfoId();
        RLock lock = redissonClient.getLock(String.format("reservation:ticketinfo:%d",ticketInfoId));
        try{
          boolean available = lock.tryLock(60,1, TimeUnit.SECONDS);
          if (!available){
            System.out.println("redisson getLock timeout");
            throw new IllegalArgumentException("redisson getLock timeout");
          }
          return reservationService.makeReservations(dto, user, ticketInfoId);
        } catch (Exception e){
          throw new RuntimeException(e);
        } finally {
          lock.unlock();
        }
      }
    }
    ```
    

- ë‚™ê´€ì ë½, ë¹„ê´€ì ë½ì´ ì•„ë‹Œ ë‹¤ë¥¸ Lockì„ ê±¸ì–´ ì†ë„ë¥¼ ê°œì„ í•´ ë³´ê³ ì Redisì—ì„œ ì§€ì›í•˜ëŠ” ë¶„ì‚°ë½(Distribution Lock)ì˜ ì¼ì¢…ì¸ Redisson Lockì„ ì ìš©í•´ë³´ê³ ì í–ˆìŠµë‹ˆë‹¤.
- Facadeë¥¼ ë§Œë“¤ì–´ ì—¬ê¸°ì„œ Lockì„ ê±´ ì±„ë¡œ ì˜ˆë§¤ ì„œë¹„ìŠ¤ ë¡œì§ì„ ì‹¤í–‰í•˜ê³  ë¡œì§ì´ ëë‚˜ë©´ unlockì„ í˜¸ì¶œí•´ ë½ì„ ë°˜ë‚©í•˜ê²Œ í–ˆìŠµë‹ˆë‹¤.
- í•˜ì§€ë§Œ í‰ê·  ì‘ë‹µì†ë„ëŠ” ê°œì„ ë˜ì§€ ì•Šê³  ì˜¤íˆë ¤ ì¦ê°€í•´ í•´ë‹¹ ì‹œë„ëŠ” ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.

[230407 ë„¤ ë²ˆì¬ í…ŒìŠ¤íŠ¸ - Redisson ë½](https://www.notion.so/230407-Redisson-4c0d95108a5b4a288f2de68d356200f9)

| ë¼ë²¨ | í‘œë³¸ ìˆ˜ | í‰ê·  ì‘ë‹µ ì†ë„ | ìµœì†Œê°’ | ìµœëŒ€ê°’ | í‘œì¤€í¸ì°¨ | ì˜¤ë¥˜ % | ì²˜ë¦¬ëŸ‰(tps) | ìˆ˜ì‹  KB/ì´ˆ | ì „ì†¡ KB/ì´ˆ | í‰ê·  ë°”ì´íŠ¸ ìˆ˜ |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| Redisson ë½ ì ìš© | 10000 | 60896ms | 52 | 138621 | 38921.097098016224 | 0.1677 | 69.15772803031875 | 48.73958419780493 | 23.620193916108217 | 721.674 |

---

### 2. Tomcat ìµœëŒ€ ì»¤ë„¥ì…˜ ìˆ˜ì™€ ì“°ë ˆë“œ í’€, DB ì»¤ë„¥ì…˜ í’€ ì¡°ì •

```yaml
server:
  tomcat:
    accept-count: 500
    threads:
      min-spare: 500
      max: 1000
    max-connections: 25000
```

- ìŠ¤í”„ë§ë¶€íŠ¸ ë‚´ì¥ ì›¹ ì„œë²„ì¸ Tomcatì˜ ì„¤ì •ì„ application.yaml ì—ì„œ ì¡°ì •í•´ ìµœëŒ€ ì»¤ë„¥ì…˜ ìˆ˜ì™€ ì“°ë ˆë“œ í’€ì„ ì„¤ì •í•˜ê³ , RDS MySQLì˜ max_connections ìˆ˜ì¹˜ë¥¼ ì¡°ì •í–ˆìŠµë‹ˆë‹¤.
- ë¯¸ë¦¬ ì“°ë ˆë“œí’€ì„ ë§Œë“¤ì–´ ì“°ë ˆë“œ ìƒì„±ì— ë¹„ìš©ì„ ì•„ë¼ê³  ìµœëŒ€ ì»¤ë„¥ì…˜ì˜ ìˆ˜ë¥¼ ëŠ˜ë ¤ ì†ë„ ê°œì„ ì„ í•´ë³´ê³ ì í–ˆìŠµë‹ˆë‹¤.
- jmeter í…ŒìŠ¤íŠ¸ ì‹œ 20K ì´ìƒ ìš”ì²­ì—ì„œ HttpHostConnectExceptionì€ ì‚¬ë¼ì¡Œì§€ë§Œ ì†ë„ì—ì„œ í° ê°œì„ ì´ ìˆë‹¤ê³  ë³¼ ìˆ˜ëŠ” ì—†ì—ˆìŠµë‹ˆë‹¤.

[230410 ë‹¤ì„¯ ë²ˆì§¸ í…ŒìŠ¤íŠ¸ ](https://www.notion.so/230410-873805553449465fbd8319c20f88e478)

| ë¼ë²¨ | í‘œë³¸ ìˆ˜ | í‰ê·  ì‘ë‹µ ì†ë„ | ìµœì†Œê°’ | ìµœëŒ€ê°’ | í‘œì¤€í¸ì°¨ | ì˜¤ë¥˜ % | ì²˜ë¦¬ëŸ‰(tps) | ìˆ˜ì‹  KB/ì´ˆ | ì „ì†¡ KB/ì´ˆ | í‰ê·  ë°”ì´íŠ¸ ìˆ˜ |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| Tomcat íŠœë‹ | 10000 | 40954ms | 106 | 86708 | 24124.13656688543 | 0.1462 | 103.48752975266481 | 69.7306353002432 | 35.98158326218566 | 689.9785 |

---

### 3. Redisì— TicketInfoì˜ ë‚¨ì€ ì¢Œì„ ìˆ˜ë¥¼ ìºì‹œë¡œ ì €ì¥í•´ ì˜ˆë§¤ ë¡œì§ì— í™œìš©

- ë‚¨ì€ ì¢Œì„ ìˆ˜ ìºì‹œ ì „ëµ(ìµœì¢…ë³¸)

![ìºì‹œì „ëµ Flow Chart.png](2%20%E1%84%87%E1%85%B5%E1%84%80%E1%85%AA%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%A8%20%E1%84%85%E1%85%A1%E1%86%A8%20%E1%84%8C%E1%85%A5%E1%86%A8%E1%84%8B%E1%85%AD%E1%86%BC%20%E1%84%89%E1%85%B5%20%E1%84%89%E1%85%A9%E1%86%A8%E1%84%83%E1%85%A9%20%E1%84%86%E1%85%AE%E1%86%AB%E1%84%8C%E1%85%A6%E1%84%85%E1%85%B3%E1%86%AF%20Redis%20Cach%2021a65fa3a8a242868a2e60bdf785752d/%25EC%25BA%2590%25EC%258B%259C%25EC%25A0%2584%25EB%259E%25B5_Flow_Chart.png)

- RedisConfig
    
    ```java
    @Configuration
    @EnableCaching
    public class RedisConfig {
    
      @Value("${spring.redis.host}")
      private String host;
    
      @Value("${spring.redis.port}")
      private int port;
    
      @Bean
      public RedisConnectionFactory redisConnectionFactory() {
        return new LettuceConnectionFactory(host, port);
      }
    
      //  LeftSeatsì— ì‚¬ìš©í•˜ëŠ” redisTemplate
      @Bean
      public RedisTemplate<String, Integer> redisTemplate() {
        RedisTemplate<String, Integer> redisTemplate = new RedisTemplate<>();
        redisTemplate.setConnectionFactory(redisConnectionFactory());
        redisTemplate.setKeySerializer(new StringRedisSerializer());
        redisTemplate.setValueSerializer(new Jackson2JsonRedisSerializer<>(Integer.class));
        return redisTemplate;
      }
    ```
    
- RedisRepository
    
    ```java
    @Component
    @RequiredArgsConstructor
    public class RedisRepository {
      private final RedisTemplate<String, Integer> redisTemplate;
      private final TicketInfoRepository ticketInfoRepository;
      private final ReservationRepository reservationRepository;
      private static final String DECREMENT_LEFT_SEAT_SCRIPT =
          "local leftSeats = tonumber(redis.call('get', KEYS[1])) " +
          "if leftSeats - ARGV[1] >= 0 then " +
          "  redis.call('decrby', KEYS[1], ARGV[1]) " +
          "  return true " +
          "else " +
          "  return false " +
          "end";
    
      private final RedisScript<Boolean> decrementLeftSeatRedisScript = new DefaultRedisScript<>(DECREMENT_LEFT_SEAT_SCRIPT, Boolean.class);
    
      //  í‚¤ë¥¼ ls1 ls2 ì´ëŸ° íŒ¨í„´ìœ¼ë¡œ "ls+ticketInfoId"ë¡œ ì €ì¥. lsëŠ” ì†Œë¬¸ì. í‚¤ê°€ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì˜ˆì™¸ì²˜ë¦¬
      public void saveTicketInfoToRedis(TicketInfo ticketInfo) {
        String key = "ls" + ticketInfo.getId();
        if (redisTemplate.hasKey(key)) {
          throw new CustomException(ExceptionType.EXISTED_CACHE_EXCEPTION);
        }
        redisTemplate.opsForValue().set(key, ticketInfo.getLeftSeats());
      }
    
    //  ë§¤ë¶„ ìºì‹œ ë³€ê²½ë¶„ì„ dbì— ì €ì¥
      @Scheduled(cron = "0 * * * * *")
      public void saveTicketInfoFromRedis(){
        Set<String> keys = redisTemplate.keys("ls*");
        if (keys.isEmpty() || keys == null) return;
        for (String key : keys) {
          Integer leftSeatsInRedis = redisTemplate.opsForValue().get(key);
          Long ticketInfoId = Long.parseLong(key.substring(2));
          TicketInfo ticketInfo = ticketInfoRepository.findById(ticketInfoId).orElseThrow(
              () -> new CustomException(ExceptionType.NOT_FOUND_TICKET_INFO_EXCEPTION));
          ticketInfo.setLeftSeats(leftSeatsInRedis);
          ticketInfoRepository.save(ticketInfo);
        }
    
      }
    
    //  keyë¡œ redisì— ìºì‹œê°€ ìˆëŠ”ì§€ ì¡°íšŒí•˜ê³  Boolean ë°˜í™˜
      public Boolean hasLeftSeatsInRedis(Long ticketInfoId){
        String key = "ls" + ticketInfoId;
        return redisTemplate.hasKey(key);
      }
    
    //  ê°’ ë³€ê²½. countë§Œí¼ ë‚¨ì€ì¢Œì„ìˆ˜ ì°¨ê°
      public Boolean decrementLeftSeatInRedis(Long ticketInfoId, int count){
        String key = "ls" + ticketInfoId;
    //    Lua Script ì‹¤í–‰
        return redisTemplate.execute(decrementLeftSeatRedisScript, Collections.singletonList(key), count);
      }
    
      //  ê°’ ë³€ê²½. countë§Œí¼ ë‚¨ì€ì¢Œì„ìˆ˜ ì¶”ê°€. ì˜ˆë§¤ì·¨ì†Œì— ì‚¬ìš©
      public void incrementLeftSeatInRedis(Long ticketInfoId, int count){
        String key = "ls" + ticketInfoId;
        redisTemplate.opsForValue().increment(key, count);
      }
    
    //  í‚¤ ì‚­ì œ. ì‚­ì œì „ leftSeats ë°˜ì˜. ìºì‹œê°€ ì—†ìœ¼ë©´ ì˜ˆì™¸ì²˜ë¦¬
      public void deleteLeftSeatsInRedis(Long ticketInfoId){
        String key = "ls" + ticketInfoId;
        if (!redisTemplate.hasKey(key)) {
          throw new CustomException(ExceptionType.NOT_FOUND_CACHE_EXCEPTION);
        }
        saveTicketInfoFromRedis();
        redisTemplate.delete(key);
      }
    
    //  í˜„ì¬ Redisì— ë“±ë¡ëœ key ëª©ë¡ ë°˜í™˜
      public Set<String> findAllLeftSeatsKeysInRedis() {
        return redisTemplate.keys("ls*");
      }
    
    // Redisì™€ DBì— ë“¤ì–´ìˆëŠ” LeftSeatì˜ ì •í•©ì„±ì„ ë§ì¶”ê¸° ìœ„í•´ Reservationì—ì„œ ticketInfoIdë¡œ ì¡°íšŒí•œ ëª¨ë“  countë¥¼ ë”í•´
    //  accurateReservedSeatsë¥¼ êµ¬í•˜ê³  totalSeatsì—ì„œ ëº€ ë‹¤ìŒ accurateReservedSeatsì„ êµ¬í•´ì„œ DBì™€ Redisì— ë§ì¶°ì¤Œ.
      public void refreshLeftSeats(Long ticketInfoId) {
        TicketInfo ticketInfo = ticketInfoRepository.findById(ticketInfoId).orElseThrow(
            () -> new CustomException(ExceptionType.NOT_FOUND_TICKET_INFO_EXCEPTION)
        );
        Integer accurateReservedSeats = reservationRepository.sumCountByTicketInfoId(ticketInfoId);
        if (accurateReservedSeats == null) {
          throw new CustomException(ExceptionType.NOT_FOUND_RESERVATION_EXCEPTION);
        }
        int accurateLeftSeats = ticketInfo.getTotalSeats() - accurateReservedSeats;
        String key = "ls" + ticketInfoId;
        ticketInfo.setLeftSeats(accurateLeftSeats);
    //    ë®ì–´ ì“°ê¸°
        redisTemplate.opsForValue().set(key, accurateLeftSeats);
      }
    }
    ```
    
- ì˜ˆë§¤ ì„œë¹„ìŠ¤ ë¡œì§
    
    ```java
    // 2. ì˜ˆë§¤í•˜ê¸°
      @Transactional(isolation = Isolation.READ_COMMITTED)
      public Long makeReservation(ReservationRequestDto dto, User user) {
        //    ë¨¼ì € redis ìºì‹œë¥¼ ì¡°íšŒ
        Boolean hasLeftSeats = redisRepository.hasLeftSeatsInRedis(dto.getTicketInfoId());
        if (hasLeftSeats) {
          //    ìºì‹œê°€ ìˆìœ¼ë©´ redisì—ì„œ ë‚¨ì€ ì¢Œì„ ìˆ˜ ì°¨ê°
          decrementLeftSeatInRedis(dto);
        } else {
          //    ìºì‹œê°€ ì—†ìœ¼ë©´ DBë¥¼ í†µí•´ ë‚¨ì€ ì¢Œì„ ìˆ˜ ì°¨ê°
          decrementLeftSeatInDB(dto);
        }
    
        Reservation reservation = new Reservation(dto, user);
        reservationRepository.saveAndFlush(reservation);
        return reservation.getId();
      }
    
      //  2-1. redisë¡œ ì¢Œì„ ìˆ˜ ë³€ê²½
      private void decrementLeftSeatInRedis(ReservationRequestDto dto) {
        Boolean success = redisRepository.decrementLeftSeatInRedis(dto.getTicketInfoId(), dto.getCount());
        if (!success) {
          throw new CustomException(ExceptionType.OUT_OF_TICKET_EXCEPTION);
        }
      }
    
      // 2-2. ìºì‹œ ì—†ìœ¼ë©´ DBë¡œ ì¢Œì„ìˆ˜ ë³€ê²½
      private void decrementLeftSeatInDB(ReservationRequestDto dto) {
        TicketInfo ticketInfo = ticketInfoRepository.findByIdWithLock(dto.getTicketInfoId()).orElseThrow(
            () -> new CustomException(ExceptionType.NOT_FOUND_TICKET_INFO_EXCEPTION)
        );
        if (!ticketInfo.isAvailable()) {
          throw new CustomException(ExceptionType.RESERVATION_UNAVAILABLE_EXCEPTION);
        }
        if (ticketInfo.getLeftSeats() - dto.getCount() < 0) {
          throw new CustomException(ExceptionType.OUT_OF_TICKET_EXCEPTION);
        }
        ticketInfo.minusSeats(dto.getCount());
        ticketInfoRepository.save(ticketInfo);
      }
    ```
    

- **ì¸ë©”ëª¨ë¦¬ ì €ì¥ì†Œ, ì‹±ê¸€ ìŠ¤ë ˆë“œ, ë‹¨ìˆœì—°ì‚°ì˜ ê²½ìš° ì›ìì„± ë³´ì¥**ì´ë¼ëŠ” íŠ¹ì„±ì„ ê°€ì§„ Redisë¥¼ ë„ì…í•´ì„œ ì†ë„ ê°œì„ ê³¼ ë™ì‹œì„±ì œì–´ ë‘ ë§ˆë¦¬ í† ë¼ë¥¼ í•œ ë²ˆì— ì¡ì•„ë³´ê³ ì í–ˆìŠµë‹ˆë‹¤.
- KeyëŠ” â€œls+ticketInfoIdâ€, ValueëŠ” TicketInfo Entityì— ìˆëŠ” LeftSeats(ë‚¨ì€ ì¢Œì„ ìˆ˜) ì»¬ëŸ¼ì˜ ë°ì´í„°ë¡œ <String, Integer> êµ¬ì¡°ì˜ â€˜Redis ê¸°ë³¸ String ìë£Œêµ¬ì¡°â€™ë¡œ Redisì— ì €ì¥í–ˆìŠµë‹ˆë‹¤.
- ì˜ˆë§¤ íŠ¸ëœì­ì…˜ì´ ì‹œì‘ë˜ë©´ ë¨¼ì € í•´ë‹¹ TicketInfoì˜ keyê°€ Redisì— ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. í•´ë‹¹ í‚¤ê°€ ìˆìœ¼ë©´ Redisë¡œ ë‚¨ì€ ì¢Œì„ ìˆ˜ë¥¼ ì°¨ê°í•´ ì˜ˆë§¤ë¥¼ ì§„í–‰í•˜ê³ , ì—†ê±°ë‚˜ Redis ì—°ê²°ì— ë¬¸ì œê°€ ìƒê¸°ë©´ ê¸°ì¡´ DBì˜ ë¹„ê´€ì  ë½ ë¡œì§ìœ¼ë¡œ ë‚¨ì€ ì¢Œì„ ìˆ˜ë¥¼ ì°¨ê°í•´ ì˜ˆë§¤ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤. (ì´ ë¡œì§ì€ íŠ¸ëŸ¬ë¸” ìŠˆíŒ… 5ë²ˆì—ì„œ ìµœì¢…ì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.)
- Redisë¡œ ì•„ë˜ì˜ Lua Scriptë¥¼ ë³´ë‚´ì„œ ë‚¨ì€ ì¢Œì„ ìˆ˜ê°€ ì˜ˆë§¤í•˜ë ¤ëŠ” ìë¦¬ ìˆ˜(count) ì´ìƒì¼ ê²½ìš° valueë¥¼ ì°¨ê°í•œ ë’¤ trueë¥¼ ë°˜í™˜í•˜ê³ , ì•„ë‹ˆë©´ falseë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë‹¨ìˆœ ì—°ì‚°ìœ¼ë¡œ ì›ìì„±ì´ ë³´ì¥ë©ë‹ˆë‹¤.

```java
  private static final String DECREMENT_LEFT_SEAT_SCRIPT =
      "local leftSeats = tonumber(redis.call('get', KEYS[1])) " +
      "if leftSeats - ARGV[1] >= 0 then " +
      "  redis.call('decrby', KEYS[1], ARGV[1]) " +
      "  return true " +
      "else " +
      "  return false " +
      "end";

public Boolean decrementLeftSeatInRedis(Long ticketInfoId, int count) {
    String key = "ls" + ticketInfoId;
    return redisTemplate.execute(decrementLeftSeatRedisScript, Collections.singletonList(key),
        count);
  }
```

- ìºì‹œ ìë™ ì ìš© ë¡œì§
    
    ```java
    @Slf4j
    @Service
    @RequiredArgsConstructor
    public class TicketInfoService {
    
      private final TicketInfoRepository ticketInfoRepository;
      private final RedisRepository redisRepository;
      private final ReservationRepository reservationRepository;
      private final RedisTemplate<String, DetailEventResponseDto> redisTemplate;
    
      /*
       * ë§¤ì¼ ìì •ì— ëŒì•„ê°€ëŠ” ìŠ¤ì¼€ì¥´ëŸ¬ ì˜¤ëŠ˜ì´ ê³µì—°ì¼ì¸ ëª¨ë“  ê³µì—°ì„ ì˜ˆë§¤ ë¶ˆê°€ëŠ¥ìœ¼ë¡œ ëŒë¦°ë‹¤.
       * repositoryì—ì„œ ì˜¤ëŠ˜ì´ ê³µì—° ë‹¹ì¼ì¸ ê³µì—°ì˜ ticketInfoë¥¼ ë‹¤ ë¶ˆëŸ¬ì˜¨ë‹¤.
       * í•´ë‹¹ ê³µì—°ì˜ dto ìºì‹œë¥¼ ì‚­ì œí•œë‹¤. í•´ë‹¹ ê³µì—°ì˜ leftSeats ìºì‹œë„ ì‚­ì œí•˜ê³  DBì— ì •í•©ì„±ì„ ë§ì¶˜ë‹¤.
       * ticketInfoì— ë³€í™”ê°€ ìƒê¸´ ê²ƒì„ repositoryì— ë°˜ì˜í•œë‹¤.
       */
      @Scheduled(cron = "0 0 0 * * ?")
      public void closeTicket() {
        List<TicketInfo> ticketInfos = ticketInfoRepository.findTicketInfoByEventDate();
        for (TicketInfo ticketInfo : ticketInfos) {
          ticketInfo.setAvailable(false);
          deleteDtoCache(ticketInfo);
          redisRepository.deleteLeftSeatsInRedis(ticketInfo);
          log.info("{}ë²ˆ ê³µì—°ì´ ì˜ˆë§¤ë¶ˆê°€ëŠ¥ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.", ticketInfo.getEvent().getId());
        }
        ticketInfoRepository.saveAll(ticketInfos);
    
      }
    
      // dto ìºì‹œë¥¼ ì‚­ì œí•˜ëŠ” private ë©”ì„œë“œ
      private void deleteDtoCache(TicketInfo ticketInfo) {
        String cacheKey = "DetailEventResponseDto::" + ticketInfo.getEvent().getId();
        Boolean eventCache = redisTemplate.hasKey(cacheKey);
        if (eventCache != null && eventCache) {
          redisTemplate.delete(cacheKey);
        }
      }
    
      /*
       * ë§¤ì¼ 18ì‹œ í‹°ì¼“ì •ë³´ì˜ openDateê°€ ì˜¤ëŠ˜ì¸ ê³µì—°ì˜ isAvailableì„ trueë¡œ ë°”ê¾¼ë‹¤.
       * í•´ë‹¹ ticketInfoì˜ leftSeatsë¥¼ redisì˜ ìºì‹œë¡œ ì €ì¥í•œë‹¤.
       */
      @Scheduled(cron = "0 0 18 * * ?")
      public void openTicket() {
        List<TicketInfo> ticketInfos = ticketInfoRepository.findTicketInfoByOpenDate();
        for (TicketInfo ticketInfo : ticketInfos) {
          deleteDtoCache(ticketInfo);
          ticketInfo.setAvailable(true);
          redisRepository.saveTicketInfoToRedis(ticketInfo);
          log.info("{}ë²ˆ ê³µì—°ì´ ì˜ˆë§¤ê°€ëŠ¥ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.", ticketInfo.getEvent().getId());
        }
        ticketInfoRepository.saveAll(ticketInfos);
      }
    ```
    
- Write Back ìºì‹œ ì „ëµ
    
    ![Untitled](2%20%E1%84%87%E1%85%B5%E1%84%80%E1%85%AA%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%A8%20%E1%84%85%E1%85%A1%E1%86%A8%20%E1%84%8C%E1%85%A5%E1%86%A8%E1%84%8B%E1%85%AD%E1%86%BC%20%E1%84%89%E1%85%B5%20%E1%84%89%E1%85%A9%E1%86%A8%E1%84%83%E1%85%A9%20%E1%84%86%E1%85%AE%E1%86%AB%E1%84%8C%E1%85%A6%E1%84%85%E1%85%B3%E1%86%AF%20Redis%20Cach%2021a65fa3a8a242868a2e60bdf785752d/Untitled.png)
    
    ê·¸ë¦¼ ì¶œì²˜([https://inpa.tistory.com/entry/REDIS-ğŸ“š-ìºì‹œCache-ì„¤ê³„-ì „ëµ-ì§€ì¹¨-ì´ì •ë¦¬](https://inpa.tistory.com/entry/REDIS-%F0%9F%93%9A-%EC%BA%90%EC%8B%9CCache-%EC%84%A4%EA%B3%84-%EC%A0%84%EB%9E%B5-%EC%A7%80%EC%B9%A8-%EC%B4%9D%EC%A0%95%EB%A6%AC))
    
- Write Back ìºì‹œ ì“°ê¸° ì „ëµìœ¼ë¡œ ìºì‹œì— ìˆëŠ” ë‚¨ì€ ì¢Œì„ ìˆ˜ ê°’ì´ DBì˜ TicketInfo í…Œì´ë¸”ì˜ LeftSeats ì»¬ëŸ¼ì— ë§¤ ë¶„ë§ˆë‹¤ ì €ì¥ë©ë‹ˆë‹¤.
- í•´ë‹¹ ìºì‹œëŠ” ì˜ˆë§¤ê°€ ì˜¤í”ˆë  ë•Œ ìƒì„±ë˜ì–´ ê³µì—°ì¼ì´ ë˜ì–´ ì˜ˆë§¤ê°€ ë‹«íˆë©´ expire ë©ë‹ˆë‹¤. ìºì‹œê°€ ì‚¬ë¼ì§€ë©´ Reservation í…Œì´ë¸”ì—ì„œ í•´ë‹¹ TicketInfoì˜ ì˜ˆë§¤ countë¥¼ ë‹¤ ë”í•´ì„œ ì •í™•í•œ ë‚¨ì€ ì¢Œì„ ìˆ˜ë¥¼ DB ì•ˆì˜ TicketInfoì— ë„£ìŠµë‹ˆë‹¤.

---

## ğŸ’¡ í•´ê²°

<aside>
ğŸ›  Redisì˜ â€˜ì›ìì  ì—°ì‚°â€™ìœ¼ë¡œ ë½ì„ ì ìš©í•˜ì§€ ì•Šì•„ë„ íŠ¸ëœì­ì…˜ì˜ ì¶©ëŒ ì—†ì´ ë‚¨ì€ ì¢Œì„ ìˆ˜ë¥¼ ì°¨ê°í•˜ëŠ” ë¡œì§ì„ êµ¬í˜„í•´ 10K ìš”ì²­ í…ŒìŠ¤íŠ¸ ì‹œ í‰ê·  ì‘ë‹µì†ë„ 11492ms(333tps).  ë¹„ê´€ì  ë½ ëŒ€ë¹„ ì•½ 76% ì˜ ì†ë„ ê°œì„ ì„ ì„±ê³µí–ˆìŠµë‹ˆë‹¤.

</aside>

[230418 ì—¬ì„¯ ë²ˆì§¸ í…ŒìŠ¤íŠ¸(ìºì‹œ ì ìš©)](https://www.notion.so/230418-16e58b3405484ce6ac0f07fd264fe9a8)

| ë¼ë²¨ | í‘œë³¸ ìˆ˜ | í‰ê·  ì‘ë‹µ ì†ë„ | ìµœì†Œê°’ | ìµœëŒ€ê°’ | í‘œì¤€í¸ì°¨ | ì˜¤ë¥˜ % | ì²˜ë¦¬ëŸ‰(tps) | ìˆ˜ì‹  KB/ì´ˆ | ì „ì†¡ KB/ì´ˆ | í‰ê·  ë°”ì´íŠ¸ ìˆ˜ |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| Redis ìºì‹œ ì ìš© | 10000 | 11492ms | 127 | 20504 | 5469.811458239943 | 0.0 | 333.8452293516726 | 117.02644575849637 | 135.95064515590573 | 358.954 |