# 4. 서버 확장으로 인한 비용 문제를 AutoScaling으로 해결

## 🆘 문제

<aside>
⚠️ 공연 예매 사이트의 특성 상 특정 시간대에 트래픽이 집중되는 반면, 나머지 시간에는 평소와 비슷한 수준의 트래픽이 예상됩니다. 이러한 상황에서 예매가 집중되지 않은 시간대에 서버 리소스가 활용되지 않아 자원 낭비가 발생할 수 있습니다.

</aside>

## 👁‍🗨 분석

<aside>
💡 서버를 수동으로 켜고 끄는 작업은 다수의 서버를 운영하는 동안 매우 어려운 일이라고 생각됩니다. 그러므로 트래픽 지표에 따라 서버를 동적으로 운영하는 방안이 필요합니다. 이를 위해, 우리는 AWS Auto Scaling을 사용하여 Load Balancer와 연동되는 서버들을 동기화하고, 인스턴스를 자동으로 추가 및 삭제하는 정책으로 운영함으로써 자원 사용량을 최적화하고 비용 절감 효과를 극대화할 수 있다고 생각합니다.

</aside>

[Amazon EC2 Auto Scaling이란 무엇입니까? - Amazon EC2 Auto Scaling](https://docs.aws.amazon.com/ko_kr/autoscaling/ec2/userguide/what-is-amazon-ec2-auto-scaling.html)

## 🌟 시도

### 1. 서버 인스턴스 교체

- 기존에 사용했던 t3.small 인스턴스를 비용이 20% 저렴하면서 성능이 20% 더 뛰어난 arm 아키텍쳐 기반의 t4g.small 인스턴스로 교체했습니다.
- 기존 linux/amd64 기반에서 linux/arm64 아키텍쳐로 변경하여 ci/cd에서 buildx를 이용하는 과정을 추가했습니다.
- GithubAcions 추가 코드
    
    ```yaml
    # Docker Buildx 설치
          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v1
    
          # QEMU Emulator 설치
          - name: Set up QEMU
            uses: docker/setup-qemu-action@v1
    
          # Docker Hub Login
          - name: Login to Docker Hub
            uses: docker/login-action@v1
            with:
              username: ${{ env.DOCKER_USERNAME }}
              password: ${{ env.DOCKER_PASSWORD }}
    
          # Docker Image Build and Push (linux/arm64,linux/amd64)
          - name: Build and push Docker Image
            uses: docker/build-push-action@v2
            with:
              context: .
              push: true
              platforms: linux/arm64,linux/amd64
              tags: ${{ env.DOCKER_USERNAME }}/이미지명
    ```
    

![스크린샷 2023-05-06 오후 11.45.21.png](4%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%8C%E1%85%A1%E1%86%BC%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%20%E1%84%86%E1%85%AE%E1%86%AB%E1%84%8C%E1%85%A6%E1%84%85%E1%85%B3%E1%86%AF%20AutoScalin%20b956bdd657be4f47be26217c6ba87231/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2023-05-06_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_11.45.21.png)

![스크린샷 2023-05-06 오후 11.45.51.png](4%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%8C%E1%85%A1%E1%86%BC%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%20%E1%84%86%E1%85%AE%E1%86%AB%E1%84%8C%E1%85%A6%E1%84%85%E1%85%B3%E1%86%AF%20AutoScalin%20b956bdd657be4f47be26217c6ba87231/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2023-05-06_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_11.45.51.png)

[AWS Graviton2 기반 Amazon EC2 T4g 인스턴스 출시 – 버스팅 용량 및 프리티어 제공 | Amazon Web Services](https://aws.amazon.com/ko/blogs/korea/new-t4g-instances-burstable-performance-powered-by-aws-graviton2/)

### 2. 오토 스케일링 적용

- Auto Scaling을 사용하여 서버를 구성하면, 지속적인 서버 교체로 인해 도커와 CodeDeploy가 새로 다운로드 및 설치해야 합니다. 그러나 이미 설치된 인스턴스를 AMI 이미지로 만들면, 새 인스턴스 시작 시 추가 설치 없이 어플리케이션을 실행할 수 있습니다.
    
    ![Untitled](4%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%8C%E1%85%A1%E1%86%BC%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%20%E1%84%86%E1%85%AE%E1%86%AB%E1%84%8C%E1%85%A6%E1%84%85%E1%85%B3%E1%86%AF%20AutoScalin%20b956bdd657be4f47be26217c6ba87231/Untitled.png)
    

![Untitled](4%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%8C%E1%85%A1%E1%86%BC%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%20%E1%84%86%E1%85%AE%E1%86%AB%E1%84%8C%E1%85%A6%E1%84%85%E1%85%B3%E1%86%AF%20AutoScalin%20b956bdd657be4f47be26217c6ba87231/Untitled.png)

### ※ 특정 시간에 자동으로 인스턴스가 추가되도록 설정

- 예를 들어, 사이트 운영 정책에 따라 티켓팅이 18:00에 시작된다면, 대용량 트래픽에 대비하기 위해 사전에 서버를 추가하고 웜업 과정을 거쳐 서버를 준비하는 방법이 있습니다.

<aside>
📍 매일 17:30에 서버 수가 최대 3개, 최소 2개로 조정되며, 현재 필요한 서버 수를 2개로 유지하게 됩니다.

</aside>

![Untitled](4%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%8C%E1%85%A1%E1%86%BC%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%20%E1%84%86%E1%85%AE%E1%86%AB%E1%84%8C%E1%85%A6%E1%84%85%E1%85%B3%E1%86%AF%20AutoScalin%20b956bdd657be4f47be26217c6ba87231/Untitled%201.png)

<aside>
📍 예를 들어, 17:30에 서버를 추가한 후, 대용량 트래픽 구간이 종료되는 시점인 18:30에 서버 수를 최대 3개, 최소 1개로 조정하고, 현재 필요한 서버 수를 1개로 유지함으로써 자원 낭비를 방지할 수 있습니다.

</aside>

![Untitled](4%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%8C%E1%85%A1%E1%86%BC%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%20%E1%84%86%E1%85%AE%E1%86%AB%E1%84%8C%E1%85%A6%E1%84%85%E1%85%B3%E1%86%AF%20AutoScalin%20b956bdd657be4f47be26217c6ba87231/Untitled%202.png)

### ※ 리소스 사용량에 따라 서버 개수를 동적으로 조절

- 평상시에도 CPU 사용량이 정해진 임계값을 초과한다면, 심각한 장애 상황에 이르기 전에 새로운 서버를 추가하여 안정성을 유지할 수 있습니다.

<aside>
📍 평상시에는 기본 설정으로 최대 서버 수를 3개, 최소 서버 수를 1개로 유지합니다.

</aside>

![스크린샷 2023-05-07 오전 12.03.51.png](4%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%8C%E1%85%A1%E1%86%BC%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%20%E1%84%86%E1%85%AE%E1%86%AB%E1%84%8C%E1%85%A6%E1%84%85%E1%85%B3%E1%86%AF%20AutoScalin%20b956bdd657be4f47be26217c6ba87231/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2023-05-07_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%258C%25E1%2585%25A5%25E1%2586%25AB_12.03.51.png)

<aside>
📍 CPU 사용률이 평균 20% 이상일 때 서버를 추가하는 CloudWatch 경보와, CPU 사용률이 10% 이하일 때 서버를 삭제하는 CloudWatch 경보를 생성합니다.

</aside>

![스크린샷 2023-05-07 오전 12.06.06.png](4%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%8C%E1%85%A1%E1%86%BC%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%20%E1%84%86%E1%85%AE%E1%86%AB%E1%84%8C%E1%85%A6%E1%84%85%E1%85%B3%E1%86%AF%20AutoScalin%20b956bdd657be4f47be26217c6ba87231/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2023-05-07_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%258C%25E1%2585%25A5%25E1%2586%25AB_12.06.06.png)

<aside>
📍 CloudWatch neticket-Scaling-out 경보가 발동이 되면 최대 3개 까지 서버 증설

</aside>

![스크린샷 2023-05-07 오전 12.14.16.png](4%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%8C%E1%85%A1%E1%86%BC%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%20%E1%84%86%E1%85%AE%E1%86%AB%E1%84%8C%E1%85%A6%E1%84%85%E1%85%B3%E1%86%AF%20AutoScalin%20b956bdd657be4f47be26217c6ba87231/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2023-05-07_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%258C%25E1%2585%25A5%25E1%2586%25AB_12.14.16.png)

<aside>
📍 CloudWatch에서 neticket-Scaling-in 경보가 발동되면 서버는 최소 1개까지 삭제되며, 필요하지 않은 리소스도 함께 제거됩니다.

</aside>

![스크린샷 2023-05-07 오전 12.14.29.png](4%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%8C%E1%85%A1%E1%86%BC%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9%20%E1%84%8B%E1%85%B5%E1%86%AB%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%20%E1%84%86%E1%85%AE%E1%86%AB%E1%84%8C%E1%85%A6%E1%84%85%E1%85%B3%E1%86%AF%20AutoScalin%20b956bdd657be4f47be26217c6ba87231/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2023-05-07_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%258C%25E1%2585%25A5%25E1%2586%25AB_12.14.29.png)

## 💡 해결

<aside>
🛠 티켓 예매 사이트라는 서비스의 특성 상 티켓 오픈 시간에 트랜잭션이 몰리기 때문에  
티켓 오픈 시간 전후와 EC2 CPU 사용율 기준으로 오토스케일링 그룹을 설정. 
서버 부하가 없는 대부분의 시간에는 서버 인스턴스가 1개로 유지되어 비용 절감.

</aside>